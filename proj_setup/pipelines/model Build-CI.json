{"options":[{"enabled":false,"definition":{"id":"5d58cc01-7c75-450c-be18-a388ddb129ec"},"inputs":{"branchFilters":"[\"+refs/heads/*\"]","additionalFields":"{}"}},{"enabled":false,"definition":{"id":"a9db38f9-9fdc-478c-b0f9-464221e58316"},"inputs":{"workItemType":"Issue","assignToRequestor":"true","additionalFields":"{}"}}],"triggers":[{"branchFilters":["+refs/heads/master"],"pathFilters":["+src","+tests","+helpers"],"batchChanges":false,"maxConcurrentBuildsPerBranch":1,"pollingInterval":0,"triggerType":2}],"variables":{"ACCOUNT_KEY":{"value":null,"isSecret":true},"ACCOUNT_NAME":{"value":null,"isSecret":true},"CONTAINER_NAME":{"value":null,"isSecret":true},"python.version":{"value":"3.7"},"RESOURCE_GROUP":{"value":null,"isSecret":true},"system.debug":{"value":"false","allowOverride":true},"WORKSPACE_NAME":{"value":null,"isSecret":true}},"properties":{},"tags":[],"_links":{"self":{"href":"https://dev.azure.com/clmccarthy/941d27f8-8d2c-47b3-b6fa-fa34a78595b8/_apis/build/Definitions/3?revision=121"},"web":{"href":"https://dev.azure.com/clmccarthy/941d27f8-8d2c-47b3-b6fa-fa34a78595b8/_build/definition?definitionId=3"},"editor":{"href":"https://dev.azure.com/clmccarthy/941d27f8-8d2c-47b3-b6fa-fa34a78595b8/_build/designer?id=3&_a=edit-build-definition"},"badge":{"href":"https://dev.azure.com/clmccarthy/941d27f8-8d2c-47b3-b6fa-fa34a78595b8/_apis/build/status/3"}},"buildNumberFormat":"$(date:yyyyMMdd)$(rev:.r)","jobAuthorizationScope":1,"jobTimeoutInMinutes":60,"jobCancelTimeoutInMinutes":5,"badgeEnabled":true,"process":{"phases":[{"steps":[{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Use Python >= 3.6","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"33c63b11-352b-45a2-ba1b-54cb568a29ca","versionSpec":"0.*","definitionType":"task"},"inputs":{"versionSpec":">= 3.6","addToPath":"true","architecture":"x64"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Install dependencies","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"d9bafed4-0b18-4f58-968d-86655b4d2ce9","versionSpec":"2.*","definitionType":"task"},"inputs":{"script":"python -m pip install --upgrade pip && pip install -r $(Build.SourcesDirectory)/requirements.txt","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Run unittests","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"d9bafed4-0b18-4f58-968d-86655b4d2ce9","versionSpec":"2.*","definitionType":"task"},"inputs":{"script":"for f in tests/*.py; do \n  python \"$f\"; \n  echo \"ran file\"\ndone\n\npython tests/test_data_preprocessing.py","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Publish Test Results **/TEST-*.xml","timeoutInMinutes":0,"condition":"succeeded()","task":{"id":"0b0f01ed-7dde-43ff-9cbb-e48954daf9b1","versionSpec":"2.*","definitionType":"task"},"inputs":{"testRunner":"JUnit","testResultsFiles":"**/TEST-*.xml","searchFolder":"$(System.DefaultWorkingDirectory)","mergeTestResults":"false","failTaskOnFailedTests":"false","testRunTitle":"","platform":"","configuration":"","publishRunAttachments":"true"}}],"name":"Run Tests","refName":"Job_1","condition":"succeeded()","target":{"executionOptions":{"type":0},"allowScriptsAuthAccessOption":false,"type":1},"jobAuthorizationScope":1},{"dependencies":[{"scope":"Job_1","event":"Completed"}],"steps":[{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Identify source files that have been changed","timeoutInMinutes":0,"condition":"succeeded()","refName":"changes","task":{"id":"e213ff0f-5d5c-4791-802d-52ea3e7be1f1","versionSpec":"2.*","definitionType":"task"},"inputs":{"targetType":"inline","filePath":"","arguments":"","script":"$files=$(git diff HEAD HEAD~ --name-only)\n$temp=$files -split ' '\n$count=$temp.Length\n$changedFiles =Â @()\necho \"Changed files: $temp\"\nFor ($i=0; $i -lt $temp.Length; $i++)\n{\n  $name=$temp[$i]\n  if ($name -like \"src/model_building/*\")\n    {\n      $changedFiles += $name\n    }\n}\n\necho \"##vso[task.setvariable variable=FILES;isSecret=false;isOutput=true;]$changedFiles\"\necho \"Changed files that are triggering model build: $changedFiles\"\n\n","errorActionPreference":"stop","failOnStderr":"false","ignoreLASTEXITCODE":"false","pwsh":"false","workingDirectory":""}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Use Python >= 3.6","timeoutInMinutes":0,"condition":"and(succeeded(), ne(variables['changes.FILES'], ''))","task":{"id":"33c63b11-352b-45a2-ba1b-54cb568a29ca","versionSpec":"0.*","definitionType":"task"},"inputs":{"versionSpec":">= 3.6","addToPath":"true","architecture":"x64"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Install dependencies","timeoutInMinutes":0,"condition":"and(succeeded(), ne(variables['changes.FILES'], ''))","task":{"id":"d9bafed4-0b18-4f58-968d-86655b4d2ce9","versionSpec":"2.*","definitionType":"task"},"inputs":{"script":"python -m pip install --upgrade pip && pip install -r $(Build.SourcesDirectory)/requirements.txt","workingDirectory":"","failOnStderr":"false"}},{"environment":{"accountname":"$(ACCOUNT_NAME)","accountkey":"$(ACCOUNT_KEY)","containername":"$(CONTAINER_NAME)"},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"run python scripts","timeoutInMinutes":0,"condition":"and(succeeded(), ne(variables['changes.FILES'], ''))","refName":"","task":{"id":"d9bafed4-0b18-4f58-968d-86655b4d2ce9","versionSpec":"2.*","definitionType":"task"},"inputs":{"script":"set -e\nexport ACCOUNTNAME=$accountname\nexport ACCOUNTKEY=$accountkey\nexport CONTAINERNAME=$containername\n\nfor i in $(changes.FILES); do \n    python $(Build.SourcesDirectory)/$i\n    echo $i\ndone\n","workingDirectory":"","failOnStderr":"false"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Install AzureML CLI Extension","timeoutInMinutes":0,"condition":"and(succeeded(), ne(variables['changes.FILES'], ''))","task":{"id":"46e4be58-730b-4389-8a2f-ea10b3e5e815","versionSpec":"1.*","definitionType":"task"},"inputs":{"connectedServiceNameARM":"6077ded6-fff7-4286-824f-cc878e600cb2","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"# Install the azureml cli extension\naz extension add -n azure-cli-ml\n\n","args":"","addSpnToEnvironment":"false","useGlobalConfig":"true","cwd":"","failOnStandardError":"false"}},{"environment":{"resourcegroup":"$(RESOURCE_GROUP)","workspacename":"$(WORKSPACE_NAME)"},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Register model with AzureML","timeoutInMinutes":0,"condition":"and(succeeded(), ne(variables['changes.FILES'], ''))","task":{"id":"46e4be58-730b-4389-8a2f-ea10b3e5e815","versionSpec":"1.*","definitionType":"task"},"inputs":{"connectedServiceNameARM":"6077ded6-fff7-4286-824f-cc878e600cb2","scriptLocation":"inlineScript","scriptPath":"","inlineScript":"set -e\n\n# Find all of the pkl files created from the previous task\nfor OUTPUT in $(find -name \"*.pkl\"); do \n    echo \"found a model\"\n    modelpath=\"${OUTPUT//\"./\"}\"\n    az ml model register --name \"${modelpath//\".pkl\"}\"  --tag buildid=$(Build.BuildId) --tag author=\"$(Build.RequestedFor)\" --model-path $(Build.SourcesDirectory)/$modelpath --output-metadata-file $(Build.SourcesDirectory)/model_metadata.json  --resource-group $resourcegroup --workspace-name $workspacename -v\n\ndone\n\nif [ -z \"$OUTPUT\" ]\nthen\n    echo \"No .pkl file was found\"\n    exit 1\nfi\n\necho \"##vso[build.addbuildtag]artifactpublished\" ","args":"","addSpnToEnvironment":"true","useGlobalConfig":"true","cwd":"","failOnStandardError":"false"}},{"environment":{},"enabled":true,"continueOnError":false,"alwaysRun":false,"displayName":"Publish Artifact: model_metadata","timeoutInMinutes":0,"condition":"and(succeeded(), ne(variables['changes.FILES'], ''))","task":{"id":"2ff763a7-ce83-4e1f-bc89-0ae63477cebe","versionSpec":"1.*","definitionType":"task"},"inputs":{"PathtoPublish":"$(Build.SourcesDirectory)/model_metadata.json","ArtifactName":"model_metadata","ArtifactType":"Container","TargetPath":"","Parallel":"false","ParallelCount":"8"}}],"name":"Build Model","refName":"Phase_2","condition":"succeeded()","target":{"executionOptions":{"type":0},"allowScriptsAuthAccessOption":true,"type":1},"jobAuthorizationScope":1}],"target":{"agentSpecification":{"identifier":"ubuntu-16.04"}},"type":1},"repository":{"properties":{"cleanOptions":"0","labelSources":"0","labelSourcesFormat":"$(build.buildNumber)","reportBuildStatus":"true","gitLfsSupport":"false","skipSyncSource":"false","checkoutNestedSubmodules":"false","fetchDepth":"0"},"id":"d27b1352-8d71-4fef-9990-b95b03f19996","type":"TfsGit","name":"mlopstemplate","url":"https://dev.azure.com/clmccarthy/mlopstemplate/_git/mlopstemplate","defaultBranch":"refs/heads/master","clean":"false","checkoutSubmodules":false},"processParameters":{},"quality":1,"authoredBy":{"displayName":"Claire McCarthy","url":"https://spsprodcus3.vssps.visualstudio.com/A6fef080d-edc3-4569-992d-176ecd752f5e/_apis/Identities/59fe4038-0923-6a36-bf42-4736eab69b25","_links":{"avatar":{"href":"https://dev.azure.com/clmccarthy/_apis/GraphProfile/MemberAvatars/aad.NTlmZTQwMzgtMDkyMy03YTM2LWJmNDItNDczNmVhYjY5YjI1"}},"id":"59fe4038-0923-6a36-bf42-4736eab69b25","uniqueName":"clmccart@microsoft.com","imageUrl":"https://dev.azure.com/clmccarthy/_apis/GraphProfile/MemberAvatars/aad.NTlmZTQwMzgtMDkyMy03YTM2LWJmNDItNDczNmVhYjY5YjI1","descriptor":"aad.NTlmZTQwMzgtMDkyMy03YTM2LWJmNDItNDczNmVhYjY5YjI1"},"drafts":[],"queue":{"_links":{"self":{"href":"https://dev.azure.com/clmccarthy/_apis/build/Queues/18"}},"id":18,"name":"Azure Pipelines","url":"https://dev.azure.com/clmccarthy/_apis/build/Queues/18","pool":{"id":9,"name":"Azure Pipelines","isHosted":true}},"id":3,"name":"model Build-CI","url":"https://dev.azure.com/clmccarthy/941d27f8-8d2c-47b3-b6fa-fa34a78595b8/_apis/build/Definitions/3?revision=121","uri":"vstfs:///Build/Definition/3","path":"\\","type":2,"queueStatus":0,"revision":121,"createdDate":"2019-08-27T22:48:58.467Z","project":{"id":"941d27f8-8d2c-47b3-b6fa-fa34a78595b8","name":"mlopstemplate","url":"https://dev.azure.com/clmccarthy/_apis/projects/941d27f8-8d2c-47b3-b6fa-fa34a78595b8","state":1,"revision":34,"visibility":2,"lastUpdateTime":"2019-08-28T00:02:01.157Z"}}